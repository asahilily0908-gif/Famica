# ğŸ·ï¸ Famica ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¡¨ç¤ºæ©Ÿèƒ½ å®Ÿè£…å®Œäº†

## ğŸ“… å®Ÿè£…æ—¥æ™‚
2025å¹´10æœˆ30æ—¥

## ğŸ¯ æ¦‚è¦
ã‚¢ãƒ—ãƒªå†…ã®ã™ã¹ã¦ã®ç”»é¢ã§ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã¯ãªãã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒå„ªå…ˆçš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

---

## âœ… å®Ÿè£…å®Œäº†å†…å®¹

### 1. FirestoreServiceä¿®æ­£

#### getMonthlyStats() - æœˆæ¬¡çµ±è¨ˆ
```dart
// ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å„ªå…ˆã§å–å¾—
final myMember = members.firstWhere(
  (m) => m['uid'] == user.uid,
  orElse: () => <String, dynamic>{},
);

// è¡¨ç¤ºåã®å„ªå…ˆé †ä½
String myName = myMember['nickname'] as String? ??   // 1. nickname
                myMember['name'] as String? ??       // 2. name
                user.displayName ??                  // 3. displayName
                'ã‚ãªãŸ';                            // 4. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
```

#### getTodayStats() - ä»Šæ—¥ã®çµ±è¨ˆ
åŒæ§˜ã«ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å„ªå…ˆã§å–å¾—ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£æ¸ˆã¿ã€‚

### 2. å¯¾å¿œç”»é¢

ä»¥ä¸‹ã®ç”»é¢ã§ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š
- âœ… ãµãŸã‚Šç”»é¢ï¼ˆCoupleScreenï¼‰
- âœ… ã‚¯ã‚¤ãƒƒã‚¯è¨˜éŒ²ç”»é¢ï¼ˆQuickRecordScreenï¼‰
- âœ… 6ãƒ¶æœˆã‚°ãƒ©ãƒ•ï¼ˆSixMonthChartWidgetï¼‰
- âœ… ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰
- âœ… ãã®ä»–ã™ã¹ã¦ã®çµ±è¨ˆç”»é¢

---

## ğŸ“ Firestoreãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### ç¾åœ¨ã®æ§‹é€ 
```javascript
households/{householdId}
{
  name: "æ¾å³¶å®¶",
  members: [
    {
      uid: "user123",
      name: "æ¾å³¶",
      role: "å¤«",
      avatar: "https://..."
    },
    {
      uid: "user456",
      name: "ä½è—¤",
      role: "å¦»",
      avatar: "https://..."
    }
  ]
}
```

### nicknameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ å¾Œ
```javascript
households/{householdId}
{
  name: "æ¾å³¶å®¶",
  members: [
    {
      uid: "user123",
      name: "æ¾å³¶",
      nickname: "ã‚ã•ã²",  // â† è¿½åŠ 
      role: "å¤«",
      avatar: "https://..."
    },
    {
      uid: "user456",
      name: "ä½è—¤",
      nickname: "ã¾ã‚Š",    // â† è¿½åŠ 
      role: "å¦»",
      avatar: "https://..."
    }
  ]
}
```

---

## ğŸ”§ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®è¨­å®šæ–¹æ³•

### æ–¹æ³•1: Firebase Consoleï¼ˆæ‰‹å‹•è¨­å®šï¼‰

1. **Firebase Consoleã«ã‚¢ã‚¯ã‚»ã‚¹**
   - https://console.firebase.google.com/

2. **Firestoreã‚’é–‹ã**
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ
   - ã€ŒFirestore Databaseã€ã‚’ã‚¯ãƒªãƒƒã‚¯

3. **householdãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ã**
   ```
   households/{your-household-id}
   ```

4. **membersé…åˆ—ã‚’ç·¨é›†**
   - membersé…åˆ—ã®å„ãƒ¡ãƒ³ãƒãƒ¼ã« `nickname` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
   - ä¾‹ï¼š
     ```json
     {
       "uid": "user123",
       "name": "æ¾å³¶",
       "nickname": "ã‚ã•ã²",
       "role": "å¤«",
       "avatar": "https://..."
     }
     ```

5. **ä¿å­˜**

### æ–¹æ³•2: Flutterã‚¢ãƒ—ãƒªã‹ã‚‰è¨­å®šï¼ˆå°†æ¥å®Ÿè£…äºˆå®šï¼‰

settings_screen.dartã«ã€Œãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®šã€æ©Ÿèƒ½ã‚’è¿½åŠ äºˆå®šï¼š

```dart
// å°†æ¥å®Ÿè£…ã™ã‚‹ã‚³ãƒ¼ãƒ‰ä¾‹
Future<void> updateNickname(String newNickname) async {
  final user = FirebaseAuth.instance.currentUser;
  final householdId = await FirestoreService().getCurrentUserHouseholdId();
  
  // householdãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
  final householdDoc = await FirebaseFirestore.instance
      .collection('households')
      .doc(householdId)
      .get();
  
  // membersé…åˆ—ã‚’æ›´æ–°
  final members = List<Map<String, dynamic>>.from(
      householdDoc.data()?['members'] ?? []);
  
  for (var member in members) {
    if (member['uid'] == user?.uid) {
      member['nickname'] = newNickname;
      break;
    }
  }
  
  // ä¿å­˜
  await FirebaseFirestore.instance
      .collection('households')
      .doc(householdId)
      .update({'members': members});
}
```

---

## ğŸ¨ è¡¨ç¤ºã®å„ªå…ˆé †ä½

### å„ç”»é¢ã§ã®åå‰è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯

1. **nickname** - membersé…åˆ—ã®nicknameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæœ€å„ªå…ˆï¼‰
2. **name** - membersé…åˆ—ã®nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
3. **displayName** - Authã®displaynameã¾ãŸã¯usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
4. **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ** - 'ã‚ãªãŸ' ã¾ãŸã¯ 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼'

### ä¾‹

```
ã‚±ãƒ¼ã‚¹1: nicknameã‚ã‚Š
nickname: "ã‚ã•ã²"
name: "æ¾å³¶"
displayName: "asahi9131"
â†’ è¡¨ç¤º: "ã‚ã•ã²"

ã‚±ãƒ¼ã‚¹2: nicknameãªã—
nickname: null
name: "æ¾å³¶"
displayName: "asahi9131"
â†’ è¡¨ç¤º: "æ¾å³¶"

ã‚±ãƒ¼ã‚¹3: nicknameã‚‚nameã‚‚ãªã—
nickname: null
name: null
displayName: "asahi9131"
â†’ è¡¨ç¤º: "asahi9131"

ã‚±ãƒ¼ã‚¹4: ã™ã¹ã¦ãªã—
nickname: null
name: null
displayName: null
â†’ è¡¨ç¤º: "ã‚ãªãŸ"
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### 1. ç¾åœ¨ã®è¡¨ç¤ºç¢ºèª
```
1. ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
2. ã€ŒãµãŸã‚Šã€ã‚¿ãƒ–ã‚’é–‹ã
3. å††ã‚°ãƒ©ãƒ•ä¸‹ã®åå‰ã‚’ç¢ºèª
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„UIDãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã“ã¨
   - nameã¾ãŸã¯displayNameãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨
```

### 2. nicknameè¨­å®šå¾Œã®ç¢ºèª
```
1. Firebase Consoleã§householdã®membersã«nicknameFieldã‚’è¿½åŠ 
2. ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆR ã‚­ãƒ¼ï¼‰
3. ã€ŒãµãŸã‚Šã€ã‚¿ãƒ–ã§ç¢ºèª
   - nicknameãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨
```

### 3. å„ç”»é¢ã§ã®ç¢ºèª
- [ ] ãµãŸã‚Šç”»é¢ã®å††ã‚°ãƒ©ãƒ•
- [ ] ãµãŸã‚Šç”»é¢ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰
- [ ] 6ãƒ¶æœˆã‚°ãƒ©ãƒ•ã®å‡¡ä¾‹
- [ ] ã‚¯ã‚¤ãƒƒã‚¯è¨˜éŒ²ç”»é¢
- [ ] AIææ¡ˆç”»é¢ï¼ˆPlusä¼šå“¡ã®ã¿ï¼‰

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆä»Šå¾Œã®æ”¹å–„ï¼‰

### Phase 1: UIè¿½åŠ ï¼ˆæ¨å¥¨ï¼‰
settings_screen.dartã«ã€Œãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç·¨é›†ã€æ©Ÿèƒ½ã‚’è¿½åŠ ï¼š
```
è¨­å®šç”»é¢
â””â”€ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š
   â”œâ”€ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : [ã‚ã•ã²] âœï¸
   â”œâ”€ å½¹å‰²: [å¤«]
   â””â”€ ã‚¢ãƒã‚¿ãƒ¼: ğŸ§‘
```

### Phase 2: åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
æ–°è¦ç™»éŒ²æ™‚ã«ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›ç”»é¢ã‚’è¿½åŠ ï¼š
```
ã‚ˆã†ã“ãFamicaã¸ï¼

ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ•™ãˆã¦ãã ã•ã„
[          ]

ï¼ˆãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‹ã‚‰ã“ã†å‘¼ã°ã‚Œã¦ã„ã¾ã™ï¼‰
```

### Phase 3: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- æ–‡å­—æ•°åˆ¶é™ï¼ˆ1-10æ–‡å­—ï¼‰
- çµµæ–‡å­—å¯¾å¿œ
- é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜householdå†…ï¼‰

---

## ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹

### å®Ÿè£…çŠ¶æ³
- [x] FirestoreServiceä¿®æ­£ï¼ˆgetMonthlyStatsï¼‰
- [x] FirestoreServiceä¿®æ­£ï¼ˆgetTodayStatsï¼‰
- [x] ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å„ªå…ˆãƒ­ã‚¸ãƒƒã‚¯
- [x] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
- [ ] è¨­å®šç”»é¢ã§ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç·¨é›†UI
- [ ] åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›

### ãƒ†ã‚¹ãƒˆçŠ¶æ³
- [x] ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚ã‚Šã®å ´åˆ
- [x] ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãªã—ã®å ´åˆ
- [x] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨
- [ ] å®Ÿæ©Ÿã§ã®å‹•ä½œç¢ºèª

---

## ğŸ’¡ Tips

### ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®æ¨å¥¨
- âœ… ã€Œã‚ã•ã²ã€ã€Œã¾ã‚Šã€ãªã©ã®å‘¼ã³å
- âœ… ã€Œãƒ‘ãƒ‘ã€ã€Œãƒãƒã€ãªã©ã®æ„›ç§°
- âœ… ã€Œå¤ªéƒã€ã€ŒèŠ±å­ã€ãªã©ã®åå‰
- âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
- âŒ é•·ã™ãã‚‹åå‰ï¼ˆ10æ–‡å­—ä»¥å†…æ¨å¥¨ï¼‰

### ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®nicknameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ç©ºï¼ˆnullï¼‰ã§ã™ã€‚
ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã§å¯¾å¿œï¼š
1. Firebase Consoleã§æ‰‹å‹•è¿½åŠ 
2. è¨­å®šç”»é¢ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ãŒè¨­å®š
3. ãƒãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ä¸€æ‹¬è¨­å®šï¼ˆname â†’ nicknameï¼‰

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### Firestore Rules
nicknameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ—¢å­˜ã®householdãƒ«ãƒ¼ãƒ«ã§ä¿è­·ã•ã‚Œã¾ã™ï¼š

```javascript
match /households/{householdId} {
  allow read, write: if request.auth != null &&
    request.auth.uid in resource.data.members[].uid;
}
```

ãƒ¡ãƒ³ãƒãƒ¼ä»¥å¤–ã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

### å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ
1. ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆR ã‚­ãƒ¼ï¼‰
2. ã‚¢ãƒ—ãƒªã‚’å®Œå…¨å†èµ·å‹•
3. Firebase Consoleã§ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèª
4. ãƒ­ã‚°ã‚’ç¢ºèªï¼ˆ`flutter logs`ï¼‰

### ã‚ˆãã‚ã‚‹è³ªå•

**Q: nicknameã‚’è¨­å®šã—ãŸã®ã«è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“**
A: ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆR ã‚­ãƒ¼ï¼‰ã¾ãŸã¯å†èµ·å‹•ã—ã¦ãã ã•ã„

**Q: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™**
A: nicknameã¨nameã®ä¸¡æ–¹ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚Firebase Consoleã§ç¢ºèªã—ã¦ãã ã•ã„

**Q: ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®nicknameã‚‚å¤‰æ›´ã§ãã¾ã™ã‹ï¼Ÿ**
A: ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼è‡ªèº«ãŒè¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆå°†æ¥ã®UIå®Ÿè£…å¾Œï¼‰

---

**å®Ÿè£…å®Œäº†**: 2025å¹´10æœˆ30æ—¥
**å®Ÿè£…è€…**: Cline AI Assistant
