# iOS AdMob「Publisher data not found」エラー診断レポート

**調査日**: 2026年1月29日  
**対象**: Famica iOS アプリ  
**エラー**: 「広告エラー: Publisher data not found. https://support.google.com/admob/answer/9905175#9」  
**目的**: コード変更なし、調査のみ

---

## 🚨 **最重要発見: アプリ ID と広告ユニット ID の不一致**

### 現在の設定状況

| 設定箇所 | 値 | プレフィックス |
|---------|-----|--------------|
| **Info.plist の GADApplicationIdentifier** | `ca-app-pub-3184270565267183~2634862619` | `ca-app-pub-3184270565267183` |
| **banner_ad_widget.dart の iOS 広告ユニット ID** | `ca-app-pub-8158788636349913/8549185583` | `ca-app-pub-8158788636349913` |

### 🔴 **重大な問題**

**AdMob アプリ ID と広告ユニット ID のプレフィックスが異なります。**

- Info.plist: `ca-app-pub-3184270565267183~...`
- 広告ユニット ID: `ca-app-pub-8158788636349913/...`

**これが「Publisher data not found」エラーの最も可能性が高い原因です。**

AdMob は広告ユニット ID (`ca-app-pub-8158788636349913/8549185583`) に対応するパブリッシャーアカウント (`ca-app-pub-8158788636349913`) を探しますが、アプリは別のアカウント (`ca-app-pub-3184270565267183`) で初期化されているため、データが見つかりません。

---

## 📊 エラーの意味と主な原因

### 「Publisher data not found」の意味

このエラーは、AdMob SDK が以下のいずれかを見つけられない場合に発生します：

1. **広告ユニット ID が存在しない**
   - AdMob コンソールで作成されていない
   - タイプミスや誤った ID

2. **アプリ ID と広告ユニット ID が一致しない**（← **最重要**）
   - Info.plist の GADApplicationIdentifier が間違っている
   - 広告ユニット ID が別のアカウント/アプリのもの

3. **アプリが AdMob に登録されていない**
   - App Store ID が未設定
   - Bundle ID が一致しない

4. **広告ユニットが無効化されている**
   - AdMob コンソールで削除または無効化
   - ポリシー違反で停止

5. **アカウント/支払い情報の問題**
   - AdMob アカウントが停止
   - 支払い情報が未設定または無効

---

## 優先度付き原因リスト（Top 5）

### 1. 🔴 **アプリ ID と広告ユニット ID の不一致**（確率: 95%）

**現状**:
- Info.plist: `ca-app-pub-3184270565267183~2634862619`
- 広告ユニット ID: `ca-app-pub-8158788636349913/8549185583`

**2つの AdMob アカウントが混在している可能性**:
- アカウント A: `ca-app-pub-3184270565267183`
- アカウント B: `ca-app-pub-8158788636349913`

**検証方法**:
1. AdMob Console (https://apps.admob.com) にログイン
2. どちらのアカウントが正しいかを確認
3. `ca-app-pub-8158788636349913` のアカウントで Famica iOS アプリが登録されているか確認
4. 広告ユニット ID `ca-app-pub-8158788636349913/8549185583` が存在するか確認

**対処法（コード修正が必要）**:
- 選択肢 A: Info.plist を `ca-app-pub-8158788636349913~XXXXX` に変更
- 選択肢 B: 広告ユニット ID を `ca-app-pub-3184270565267183/XXXXX` に変更

---

### 2. 🟠 **iOS アプリが AdMob に正しく登録されていない**（確率: 60%）

**要確認項目**:
- AdMob Console でアプリのステータスが「要審査」または「セットアップ中」
- App Store ID が未設定または誤っている
- Bundle ID が一致しない（期待: `com.matsushima.famica`）

**AdMob の審査ステータス**:
- ✅ **有効**: 広告配信可能
- ⚠️ **要審査**: 審査待ち（通常 1〜2 日、広告リクエストは可能だが配信されない場合あり）
- ⚠️ **セットアップ中**: アプリ情報が不完全（配信不可）
- 🔴 **無効**: ポリシー違反や削除（配信不可）

**検証方法**:
1. AdMob Console → アプリ → Famica (iOS) を選択
2. ステータスを確認
3. App Store の詳細を確認:
   - App Store ID: 期待値を確認（App Store Connect から取得）
   - Bundle ID: `com.matsushima.famica` であることを確認

---

### 3. 🟡 **広告ユニット ID が存在しない、または無効**（確率: 40%）

**現在の広告ユニット ID**: `ca-app-pub-8158788636349913/8549185583`

**要確認項目**:
- この ID が AdMob Console に存在するか
- ステータスが「有効」か
- フォーマットが「バナー」か
- プラットフォームが「iOS」か

**検証方法**:
1. AdMob Console → 広告ユニット
2. `ca-app-pub-8158788636349913/8549185583` を検索
3. 存在しない場合は「Publisher data not found」エラーが出る
4. 存在する場合、ステータスを確認

---

### 4. 🟡 **app-ads.txt の未検証（影響は限定的）**（確率: 20%）

**app-ads.txt の役割**:
- 広告在庫の正当性を証明
- **検証されていなくても広告配信は可能**（ただし一部の広告主が入札を避ける可能性）
- クローラーの確認に数日〜数週間かかる場合がある

**AdMob Console での警告**:
- 「app-ads.txt が検証されていません」
- 「クローラーが確認中です」

**対処**:
- app-ads.txt は設定済みであれば、時間の経過を待つ
- **これ単体では「Publisher data not found」エラーの原因にはならない**

---

### 5. 🟢 **AdMob アカウントの支払い設定または制限**（確率: 15%）

**要確認項目**:
- AdMob アカウントのステータス
- 支払い情報が設定されているか
- アカウントが停止されていないか
- 広告配信制限がかかっていないか

**検証方法**:
1. AdMob Console → アカウント情報
2. ステータスを確認:
   - ✅ **有効**
   - ⚠️ **要対応**: 支払い情報や本人確認が必要
   - 🔴 **停止**: ポリシー違反
3. 支払い情報 → 支払いプロファイルが設定されているか確認

---

## ✅ AdMob Console 確認チェックリスト

### Phase 1: アカウントとアプリの基本確認

- [ ] **Step 1.1**: AdMob Console (https://apps.admob.com) にログイン
- [ ] **Step 1.2**: 現在ログインしているアカウントの Publisher ID を確認
  - 画面右上のアカウント情報から確認
  - `ca-app-pub-3184270565267183` か `ca-app-pub-8158788636349913` のどちらか？
- [ ] **Step 1.3**: 「アプリ」セクションで Famica (iOS) を探す
  - 見つからない場合、アカウントを切り替えて再確認
  - 複数の AdMob アカウントを持っている場合は全て確認

### Phase 2: アプリのステータスと設定確認

- [ ] **Step 2.1**: アプリの詳細ページを開く
- [ ] **Step 2.2**: アプリのステータスを確認:
  - [ ] ✅ **有効**: 広告配信可能
  - [ ] ⚠️ **要審査**: 審査待ち
  - [ ] ⚠️ **セットアップ中**: 情報が不完全
  - [ ] 🔴 **無効**: 削除または停止
- [ ] **Step 2.3**: App Store の詳細を確認:
  - [ ] **App Store ID**: 設定されているか？（例: `1234567890`）
  - [ ] **Bundle ID**: `com.matsushima.famica` と一致するか？
  - [ ] **プラットフォーム**: iOS が選択されているか？
- [ ] **Step 2.4**: アプリの「AdMob アプリ ID」を確認:
  - 形式: `ca-app-pub-XXXXXXXX~XXXXXXXXXX`（`~` の後に数字）
  - これが Info.plist の `GADApplicationIdentifier` と一致する必要がある

### Phase 3: 広告ユニットの確認

- [ ] **Step 3.1**: 「広告ユニット」セクションに移動
- [ ] **Step 3.2**: `ca-app-pub-8158788636349913/8549185583` を検索
- [ ] **Step 3.3**: 存在する場合:
  - [ ] **ステータス**: 「有効」か？
  - [ ] **広告フォーマット**: 「バナー」か？
  - [ ] **プラットフォーム**: 「iOS」か？
  - [ ] **アプリ**: Famica (iOS) に紐づいているか？
- [ ] **Step 3.4**: 存在しない場合:
  - 別のアカウントで作成されている可能性
  - または誤った ID をコードに記載している

### Phase 4: 支払い情報とアカウントステータス

- [ ] **Step 4.1**: AdMob Console → アカウント情報
- [ ] **Step 4.2**: アカウントステータスを確認:
  - [ ] ✅ **有効**
  - [ ] ⚠️ **要対応**: 必要なアクションを完了
  - [ ] 🔴 **停止**: 理由を確認
- [ ] **Step 4.3**: 支払い情報 → 支払いプロファイル:
  - [ ] 名前、住所が設定されているか
  - [ ] 税務情報が入力されているか（必要に応じて）
- [ ] **Step 4.4**: 「広告配信制限」がかかっていないか確認
  - ポリシー違反や無効なトラフィックが検出されると制限がかかる

### Phase 5: app-ads.txt の確認（優先度低）

- [ ] **Step 5.1**: AdMob Console → アプリ → app-ads.txt
- [ ] **Step 5.2**: ステータスを確認:
  - [ ] ✅ **検証済み**
  - [ ] ⚠️ **検証中**: クローラーが確認中（数日待つ）
  - [ ] ⚠️ **未検証**: URL が正しくない、またはクローラーがアクセスできない
- [ ] **Step 5.3**: app-ads.txt の URL を確認:
  - 期待される URL: `https://famica-app.web.app/app-ads.txt` など
  - ブラウザで直接アクセスして内容を確認
- [ ] **Step 5.4**: app-ads.txt の内容を確認:
  ```
  google.com, pub-8158788636349913, DIRECT, f08c47fec0942fa0
  ```
  - Publisher ID が広告ユニット ID のプレフィックスと一致するか

---

## ✅ iOS デバイス確認チェックリスト

### Phase 1: テスト広告 vs 本番広告の確認

- [ ] **Step 1.1**: `lib/widgets/banner_ad_widget.dart` の 33 行目を確認
  ```dart
  const bool USE_TEST_ADS = false;
  ```
- [ ] **Step 1.2**: テストモードで動作確認:
  - `USE_TEST_ADS = true;` に変更
  - アプリを再ビルド: `flutter run -d <device-id>`
  - テスト広告が表示されるか確認
- [ ] **Step 1.3**: テスト広告が表示される場合:
  - Google Mobile Ads SDK は正常に動作している
  - 問題は本番広告 ID または AdMob 設定にある
- [ ] **Step 1.4**: テスト広告も表示されない場合:
  - AdMob SDK の初期化に問題がある
  - Info.plist の設定を確認
  - ATT 権限を確認

### Phase 2: AdMob 広告配信の時間的遅延

**新しく作成した広告ユニットの場合**:
- [ ] **広告ユニット作成から 24 時間以上経過しているか？**
  - AdMob は新規広告ユニットの配信開始まで数時間〜24 時間かかる場合がある
  - 「Publisher data not found」が出る場合、時間だけでは解決しない可能性が高い

**アプリを AdMob に新規登録した場合**:
- [ ] **アプリ登録から 24〜48 時間経過しているか？**
  - AdMob の審査が完了するまで広告が配信されない場合がある
  - ステータスが「要審査」→「有効」に変わるのを待つ

### Phase 3: ATT（App Tracking Transparency）の確認

- [ ] **Step 3.1**: iOS 設定を開く
- [ ] **Step 3.2**: 設定 → プライバシーとセキュリティ → トラッキング
- [ ] **Step 3.3**: Famica アプリを探す
- [ ] **Step 3.4**: トラッキングが許可されているか確認:
  - ✅ **オン**: 許可（推奨）
  - ❌ **オフ**: 拒否（広告配信に影響する可能性）

**ATT の影響**:
- ATT を拒否しても広告自体は表示されるべき（ただしパーソナライズされない）
- 一部の広告主が入札を避ける可能性があり、フィルレートが下がる
- 「Publisher data not found」の直接的な原因にはならない

**AdMob Console での確認**:
- [ ] AdMob Console → レポート
- [ ] ATT ステータス別のリクエスト数を確認
- [ ] 「許可」「拒否」「未決定」の割合を確認

### Phase 4: ネットワーク環境とリージョン

- [ ] **Step 4.1**: インターネット接続を確認
  - Wi-Fi または モバイルデータ が有効か
  - 他のアプリでネットワーク通信ができるか
- [ ] **Step 4.2**: VPN やプロキシを無効化
  - VPN 経由だと広告配信が制限される場合がある
- [ ] **Step 4.3**: デバイスの地域設定を確認
  - 設定 → 一般 → 言語と地域
  - 日本に設定されているか（広告在庫が多い地域）
- [ ] **Step 4.4**: フィルレート（Fill Rate）の影響:
  - 地域や時間帯によって広告在庫が少ない場合がある
  - テスト広告は常に表示されるため、フィルレート問題の切り分けに有効

---

## 📸 証拠収集方法

### AdMob Console でのスクリーンショット

#### 1. アカウント情報ページ
- [ ] **撮影箇所**: AdMob Console トップ → 右上のアカウント名をクリック
- [ ] **確認項目**:
  - Publisher ID（`ca-app-pub-XXXXXXXX`）
  - アカウント名
  - アカウントステータス

#### 2. アプリ一覧ページ
- [ ] **撮影箇所**: AdMob Console → アプリ
- [ ] **確認項目**:
  - Famica (iOS) が表示されているか
  - アプリのステータス（有効 / 要審査 / セットアップ中）
  - AdMob アプリ ID

#### 3. アプリ詳細ページ
- [ ] **撮影箇所**: AdMob Console → アプリ → Famica (iOS)
- [ ] **確認項目**:
  - App Store ID
  - Bundle ID
  - プラットフォーム
  - app-ads.txt のステータス

#### 4. 広告ユニット一覧ページ
- [ ] **撮影箇所**: AdMob Console → 広告ユニット
- [ ] **確認項目**:
  - `ca-app-pub-8158788636349913/8549185583` が存在するか
  - ステータス（有効 / 無効）
  - 広告フォーマット（バナー）

#### 5. 広告ユニット詳細ページ（存在する場合）
- [ ] **撮影箇所**: 該当広告ユニットをクリック
- [ ] **確認項目**:
  - 広告ユニット ID
  - 紐づいているアプリ名
  - 設定内容

#### 6. レポートページ（過去 7 日間）
- [ ] **撮影箇所**: AdMob Console → レポート
- [ ] **確認項目**:
  - リクエスト数
  - インプレッション数
  - 推定収益額（¥7 など）
  - どのアプリ / 広告ユニットでデータが記録されているか

#### 7. 支払い情報ページ
- [ ] **撮影箇所**: AdMob Console → 支払い
- [ ] **確認項目**:
  - 支払いプロファイルが設定されているか
  - アカウントの健全性ステータス

### Xcode Console でのログ

#### 1. AdMob 初期化ログ
```
# 検索キーワード: "AdMob", "MobileAds"

期待されるログ:
✅ AdMob初期化成功
   初期化ステータス: {...}
   リクエスト設定: 完了
✅ ATT初期化完了: authorized
```

#### 2. 広告読み込みログ
```
# 検索キーワード: "BannerAd"

期待されるログ（成功時）:
🔷 [BannerAd] 広告読み込み開始
   プラットフォーム: iOS
   本番モード: 本番広告IDを使用
   広告ユニットID: ca-app-pub-8158788636349913/8549185583
✅ [BannerAd] 広告読み込み成功
   サイズ: 320x50

エラー時のログ:
❌ [BannerAd] 広告読み込み失敗
   エラーコード: X
   エラーメッセージ: Publisher data not found.
   エラードメイン: com.google.admob
   レスポンス情報: {...}
💡 診断: ...
```

#### 3. Google Mobile Ads SDK の内部ログ
```
# 検索キーワード: "GAD", "GMSDK"

# Xcode Console でフィルタ設定:
- Process: Runner
- Subsystem: com.google.gma
```

#### 4. ネットワークログ
```
# 検索キーワード: "NSURLSession", "HTTP"

# AdMob へのリクエストが送信されているか確認
# レスポンスコード: 200 (成功) / 400, 404 (エラー)
```

### デバイスでのスクリーンショット

#### 1. エラー表示画面（デバッグモード）
- [ ] **撮影対象**: アプリ画面下部の赤いエラーバー
- [ ] **確認項目**: 「広告エラー: Publisher data not found.」

#### 2. iOS 設定 → トラッキング
- [ ] **撮影箇所**: 設定 → プライバシーとセキュリティ → トラッキング
- [ ] **確認項目**: Famica のトラッキング許可状況

#### 3. iOS 設定 → 地域
- [ ] **撮影箇所**: 設定 → 一般 → 言語と地域
- [ ] **確認項目**: 地域が「日本」になっているか

---

## 🎯 推奨される次のアクション（調査・確認のみ）

### 優先度1: アカウント不一致の確認（最重要）

```
1. AdMob Console で ca-app-pub-8158788636349913 のアカウントを探す
2. このアカウントに Famica iOS アプリが登録されているか確認
3. 広告ユニット ca-app-pub-8158788636349913/8549185583 が存在するか確認
4. Info.plist の GADApplicationIdentifier と照合
```

**期待される結果**:
- アカウント `ca-app-pub-8158788636349913` が見つかる
- Famica iOS アプリが登録されている
- 広告ユニット ID が存在し、有効である
- → この場合、Info.plist を修正する必要がある

**または**:
- アカウント `ca-app-pub-3184270565267183` が正しい
- Famica iOS アプリはこちらに登録されている
- → この場合、広告ユニット ID を修正する必要がある

---

### 優先度2: テスト広告での動作確認

```
1. banner_ad_widget.dart の USE_TEST_ADS を true に変更（一時的）
2. アプリを再ビルド
3. テスト広告が表示されるか確認
```

**結果の解釈**:
- ✅ **テスト広告が表示される**: SDK は正常、本番 ID または AdMob 設定に問題
- ❌ **テスト広告も表示されない**: SDK 初期化または基本設定に問題

---

### 優先度3: AdMob レポートでのデータ確認

```
1. AdMob Console → レポート
2. 過去 7 日間のデータを確認
3. どのアプリ・広告ユニットでリクエストが記録されているか確認
```

**期待される発見**:
- リクエスト数 > 0 だが、インプレッション数 = 0
- → 広告ユニット ID は正しいが、他の問題がある可能性

---

### 優先度4: Xcode Console のログ全文を保存

```
1. Xcode で iOS 実機に接続
2. flutter run -d <device-id>
3. アプリ起動から広告読み込みまでのログをすべて保存
4. 特に以下を重点的に確認:
   - AdMob 初期化ログ
   - 広告ユニット ID
   - エラーメッセージ
   - レスポンス情報
```

---

### 優先度5: AdMob サポートへの問い合わせ準備

**以下の情報を準備**:
1. AdMob Publisher ID（`ca-app-pub-XXXXXXXX`）
2. iOS アプリの Bundle ID（`com.matsushima.famica`）
3. 広告ユニット ID（`ca-app-pub-8158788636349913/8549185583`）
4. エラーメッセージの全文
5. AdMob Console のスクリーンショット
6. Xcode Console のログ

**問い合わせ先**:
- AdMob ヘルプセンター: https://support.google.com/admob
- 「お問い合わせ」から具体的な状況を説明

---

## 📝 まとめ

### 最も可能性が高い原因

🔴 **アプリ ID と広告ユニット ID のプレフィックス不一致**

- Info.plist: `ca-app-pub-3184270565267183~2634862619`
- 広告ユニット ID: `ca-app-pub-8158788636349913/8549185583`

### 次に確認すべきこと

1. ✅ AdMob Console で両方のアカウントを確認
2. ✅ どちらのアカウントに Famica iOS アプリが登録されているか特定
3. ✅ 広告ユニット ID が存在するか確認
4. ✅ テスト広告で SDK が正常動作するか確認

### 「Publisher data not found」を解決するには

**最も確実な方法**:
1. AdMob Console で正しいアカウントを特定
2. そのアカウントのアプリ ID と広告ユニット ID を使用
3. Info.plist と banner_ad_widget.dart を一致させる

**時間がかかる可能性があるもの**:
- AdMob の審査待ち（1〜2 日）
- 新規広告ユニットの配信開始待ち（数時間〜24 時間）
- app-ads.txt の検証待ち（数日〜数週間、ただし広告配信には影響しない）

---

**調査完了日時**: 2026年1月29日 23:21  
**次回アクション**: 上記のチェックリストに従って AdMob Console を確認
