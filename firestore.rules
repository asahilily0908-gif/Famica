rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ”¹ usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // ğŸ”¹ usersã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆcustomCategoriesï¼‰
      match /customCategories/{categoryId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ğŸ”¹ householdsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /households/{householdId} {
      // âœ… èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰å…¨ã¦ã®householdæ“ä½œã‚’è¨±å¯
      // ï¼ˆmembersãƒã‚§ãƒƒã‚¯ã¯fallbackãƒ«ãƒ¼ãƒ«ã§å‡¦ç†ï¼‰
      allow read, write, create, update: if request.auth != null;

      // ğŸ”¹ householdä»¥ä¸‹ã®å…¨ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
      match /{document=**} {
        allow read, write: if request.auth != null;
      }
    }

    // ğŸ”¹ inviteCodesã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¸€åº¦ãã‚Šæ‹›å¾…ã‚³ãƒ¼ãƒ‰ï¼‰
    match /inviteCodes/{code} {
      // èª­ã¿å–ã‚Š: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰èª°ã§ã‚‚å¯èƒ½ï¼ˆæ¤œè¨¼ã®ãŸã‚ï¼‰
      allow read: if request.auth != null;
      
      // ä½œæˆ: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰èª°ã§ã‚‚å¯èƒ½ï¼ˆhouseholdä½œæˆæ™‚ï¼‰
      allow create: if request.auth != null 
        && request.resource.data.householdId is string
        && request.resource.data.used == false;
      
      // æ›´æ–°: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰èª°ã§ã‚‚å¯èƒ½ï¼ˆä½¿ç”¨æ¸ˆã¿ãƒãƒ¼ã‚¯ç”¨ï¼‰
      // ãŸã ã—ã€used=falseã‹ã‚‰used=trueã¸ã®å¤‰æ›´ã®ã¿è¨±å¯
      allow update: if request.auth != null
        && resource.data.used == false
        && request.resource.data.used == true;
      
      // å‰Šé™¤: ç¦æ­¢ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚è¨˜éŒ²ã‚’ä¿æŒï¼‰
      allow delete: if false;
    }

    // ğŸ”¹ gratitudeMessagesã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç‰ˆï¼‰
    match /gratitudeMessages/{messageId} {
      // ä½œæˆ: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®fromUserIdã§ä½œæˆã™ã‚‹å ´åˆã®ã¿
      // householdIdã¨toUserIdãŒå¿…é ˆ
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.fromUserId
        && request.resource.data.householdId is string
        && request.resource.data.toUserId is string;
      
      // èª­å–: é€ä¿¡è€…ã¾ãŸã¯å—ä¿¡è€…ã®ã¿
      allow read: if request.auth != null
        && (request.auth.uid == resource.data.fromUserId
            || request.auth.uid == resource.data.toUserId);
      
      // æ›´æ–°: å—ä¿¡è€…ã®ã¿ï¼ˆæ—¢èª­ãƒ•ãƒ©ã‚°æ›´æ–°ç”¨ï¼‰
      // isReadãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å¤‰æ›´å¯èƒ½
      allow update: if request.auth != null
        && request.auth.uid == resource.data.toUserId
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
      
      // å‰Šé™¤: ç¦æ­¢ï¼ˆãƒ­ã‚°ä¿æŒã®ãŸã‚ï¼‰
      allow delete: if false;
    }

    // ğŸ”¹ fallbackï¼ˆé–‹ç™ºãƒ»ç”³è«‹ç”¨ã®ä¿é™ºçš„è¨±å¯ï¼‰
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
